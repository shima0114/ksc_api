
<header>
    <div class="page-header">
        <h3>写真編集</h3>
    </div>
</header>
<div class="container-fluid">
    <ul class="nav nav-tabs">
        <li class="nav-item active">
            <a href="#album" class="nav-link navbar-default" data-toggle="tab" onclick="changeCategory('album')">アルバム</a>
        </li>
        <li class="nav-item">
            <a href="#player" class="nav-link navbar-default" data-toggle="tab" onclick="changeCategory('player')">選手</a>
        </li>
        <li class="nav-item">
            <a href="#staff" class="nav-link navbar-default" data-toggle="tab" onclick="changeCategory('staff')">スタッフ</a>
        </li>
    </ul>
    <div class="tab-content">
      <div id="album" class="tab-pane active">
          <div class="form-group">
              <label for="photo_category">新規・追加</label>
              <select id="photo_category" class="form-control" onchange="changeProc()">
                  <option value="new" selected>新規</option>
                  <option value="add">追加</option>
              </select>
          </div>

          <div id="album_new">
              <div class="form-group">
                  <label for="year_option">年度</label>
                  <input type="text" class="form-control" id="input_year">
              </div>
              <div class="form-group">
                  <label for="photo_title">タイトル</label>
                  <input type="text" class="form-control" id="input_group_title">
              </div>
          </div>
          <div id="album_add" hidden>
              <div class="form-group">
                  <label for="year_option">年度</label>
                  <select id="year_option" class="form-control" onchange="changeYear()">
                      <option selected hidden>選択してください</option>
                  </select>
              </div>
              <div class="form-group">
                  <label for="photo_title">タイトル</label>
                  <select id="photo_title" class="form-control overflow" onchange="selectGroupTitle()">
                      <option selected hidden>選択してください</option>
                  </select>
              </div>
          </div>

      </div>
      <div id="player" class="tab-pane">
          編集中
          <!--<form>
              <div class="form-group ">
                  <label for="new_photo_category">登録先</label>
                  <select id="new_photo_category" class="form-control" onchange="changeInput()">
                      <option selected disabled>選択してください</option>
                      <option>アルバム</option>
                      <option>選手</option>
                      <option>スタッフ</option>
                  </select>
              </div>
              <div class="form-group " id="new_year_group">
                  <label for="new_photo_date">年度</label>
                  <input id="new_photo_date" name="match_date" type="text" class="form-control">
              </div>
              <div class="form-group ">
                  <label for="new_photo_title">タイトル</label>
                  <input id="new_photo_title" name="match_venue" type="text" class="form-control">
              </div>
              <input id="new_next" type="button" value="次へ" onclick="inputDetail()">
          </form>-->
      </div>
        <div id="staff" class="tab-pane">
            編集中
            <!--<form>
                <div class="form-group ">
                    <label for="new_photo_category">登録先</label>
                    <select id="new_photo_category" class="form-control" onchange="changeInput()">
                        <option selected disabled>選択してください</option>
                        <option>アルバム</option>
                        <option>選手</option>
                        <option>スタッフ</option>
                    </select>
                </div>
                <div class="form-group " id="new_year_group">
                    <label for="new_photo_date">年度</label>
                    <input id="new_photo_date" name="match_date" type="text" class="form-control">
                </div>
                <div class="form-group ">
                    <label for="new_photo_title">タイトル</label>
                    <input id="new_photo_title" name="match_venue" type="text" class="form-control">
                </div>
                <input id="new_next" type="button" value="次へ" onclick="inputDetail()">
            </form>-->
        </div>
    <div id="loading" />
    <form id="file_upload_form" method="post" enctype="multipart/form-data">
        <input id="image_group_id" type="hidden" value="" name="id">
        <div class="input-group">
            <label class="input-group-btn">
        <span class="btn btn-default">
            写真選択<input id="upload_file" name="upload_file" type="file" style="display:none">
        </span>
            </label>
            <input id="upload_file_name" type="text" class="form-control" readonly="">
        </div>
        <div class="form-group">
            <label for="title_1">写真タイトル</label>
            <input class="form-control" id="title_1" type="text" name="title" placeholder="空白でも構いません">
        </div>
        <div class="text-right form-inline">
            <!--<input class="form-control" id="add_photo" type="button" value="写真追加" onclick="addPhoto()">-->
            <input class="form-control" id="mod_next" type="button" value="登録" onclick="addPhoto()">
        </div>
        <input type="hidden" name="proc" id="proc" value="new">
        <input type="hidden" name="category" id="category" value="album">
        <input type="hidden" name="year" id="send_year" value="">
        <input type="hidden" name="group-title" id="send_group_title" value="">
    </form>
    </div>
</div>
<div class="modal fade" id="modal-result" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-body" id="result-msg">

            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">閉じる</button>
            </div>
        </div>
    </div>
</div>

<script type="text/javascript">
    $("#upload_file").on('change', function() {
        var input = $(this),
            numFiles = input.get(0).files ? input.get(0).files.length : 1,
            label = input.val().replace(/\\/g, '/').replace(/.*\//, '');
        $("#upload_file_name").val(label);
    });

    function addPhoto() {
        $("#loading").html("<img src='/images/load.gif'/>");
        // Create form data
        $('#send_year').val($("#input_year").val());
        $('#send_group_title').val($("#input_group_title").val());
        var fd = new FormData($('#file_upload_form').get(0));
        fd.append("file", $("#upload_file").prop("files")[0]);
        $.ajax({
            url: '/api/index.php/File/upload/album',
            type: 'post',
            dataType: 'json',
            data: fd,
            processData: false,
            contentType: false
        })
            .done(function(res){
                $("#upload_file").val('');
                $("#upload_file_name").val('');
                $("#result-msg").text('成功');
                $('#modal-result').modal("show");
            })
            .fail(function(jqXHR, statusText, errorThrown){
                $("#result-msg").text('失敗');
                $('#modal-result').modal("show");
                console.log(jqXHR, statusText, errorThrown);
            })
            .always(function(res) {
                $("#loading").empty();
                window.setTimeout("$('#modal-result').modal('hide')", 3000);
            });
        return this;

    }

    function changeCategory(category) {
        $("#category").val(category);
    }

    function changeProc() {
        $("#year_group_area").empty();
        var procCode = $("#photo_category").find("option:selected").val();
        $("#proc").val(procCode);
        if (procCode === "add") {
            $("#album_new").hide();
            $("#album_add").show();
            addOptionTag("#year_option", "/Album/lists/year", "");
        } else if (procCode === "new") {
            $("#album_add").hide();
            $("#album_new").show();
            $("#photo_title").find("option:gt(0)").remove();
        } else {
            alert("Valid option selected. Please contact administrator.");
            return;
        }
    }

    function changeYear() {
        var year = $("#year_option").find("option:selected").val();
        addOptionTag("#photo_title", "/Album/lists/title/?year="+year, "album_");
    }

    function selectGroupTitle() {
        var groupId = $("#photo_title").find("option:selected").attr("id");
        $("#image_group_id").val(groupId);
    }

    function addOptionTag(selector, apiUrl, idPrefix) {
        // parent select initialize.
        $(selector).empty();
        // create information option tag.
        var $optInfoTag = $("<option selected hidden>選択してください</option>");
        $(selector).append($optInfoTag);

        $.getJSON(urlPrefix+apiUrl, function(jsonData) {
            $.each(jsonData["album"], function () {
                // option tag initialize.
                var $optTag = $("<option>").addClass("overflow");
                // add value
                $optTag.attr("id", idPrefix + this["id"]).val(this["value"]).text(this["value"]);
                // append parent select tag
                $(selector).append($optTag);
            });
        });
    }
    //# sourceURL=on_debug.js
</script>